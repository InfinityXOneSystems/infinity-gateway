name: Deploy Credential Manager

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP with Workload Identity
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WI_POOL }}/providers/${{ secrets.WI_PROVIDER }}
          service_account: ${{ secrets.CREDENTIAL_MANAGER_SA }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Build container
        run: |
          IMAGE=gcr.io/${{ secrets.GCP_PROJECT_ID }}/credential-manager:${{ github.sha }}
          docker build -t $IMAGE ./credential_manager
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Configure docker authentication and push
        run: |
          gcloud auth configure-docker --quiet
          docker push $IMAGE

      - name: Terraform Init and Apply (infra)
        env:
          TF_IN_AUTOMATION: 1
        run: |
          cd infra
          terraform init
          terraform apply -auto-approve -var="project_id=${{ secrets.GCP_PROJECT_ID }}" -var="credential_manager_image=$IMAGE" -var="credential_manager_sa=${{ secrets.CREDENTIAL_MANAGER_SA }}" -var="github_repo=${{ github.repository }}" -var="wi_pool_id=${{ secrets.WI_POOL }}" -var="wi_provider_id=${{ secrets.WI_PROVIDER }}"

      - name: Populate Secret Manager from GitHub Secrets (placeholder)
        if: ${{ always() }}
        run: |
          # This step demonstrates securely copying GitHub secrets into GCP Secret Manager
          # It uses gcloud (authenticated via Workload Identity above). Replace SECRET_* placeholders.
          set -e
          CM_SECRET_NAMES=("test-secret" "sheets-agent-key")
          for s in "${CM_SECRET_NAMES[@]}"; do
            # Read from GitHub Secrets into env var (use secrets.SECRET_NAME)
            case "$s" in
              "test-secret") val="${{ secrets.TEST_SECRET }}" ;;
              "sheets-agent-key") val="${{ secrets.SHEETS_AGENT_KEY }}" ;;
              *) val="" ;;
            esac
            if [ -n "$val" ]; then
              echo "$val" | gcloud secrets create "$s" --data-file=- --project=${{ secrets.GCP_PROJECT_ID }} || \
                echo "$val" | gcloud secrets versions add "$s" --data-file=- --project=${{ secrets.GCP_PROJECT_ID }}
            else
              echo "Skipping $s - GitHub secret not set"
            fi
          done
name: Deploy Credential Manager

on:
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Terraform Init
        run: |
          cd infra
          terraform init
      - name: Terraform Apply
        run: |
          cd infra
          terraform apply -auto-approve -var="project=${{ secrets.GCP_PROJECT_ID }}"

  build-deploy:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
      - name: Build and push image
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/credential-manager:latest ./credential_manager
          echo "Pushing..."
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/credential-manager:latest
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy credential-manager --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/credential-manager:latest --region=us-east1 --platform=managed --allow-unauthenticated

  integration-tests:
    needs: build-deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
      - name: Wait for service
        run: |
          echo "Waiting for credential-manager to be ready..."
          sleep 20
      - name: Get service URL
        id: svc
        run: |
          URL=$(gcloud run services describe credential-manager --region=us-east1 --platform=managed --format='value(status.url)')
          echo "service_url=$URL" >> $GITHUB_OUTPUT
      - name: Run health check
        run: |
          curl -sS ${{ steps.svc.outputs.service_url }}/health
      - name: Run sheet creation test
        env:
          CREDENTIAL_MANAGER_URL: ${{ steps.svc.outputs.service_url }}
          TEST_SA_EMAIL: sheets-agent@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com
        run: |
          pip install google-api-python-client requests
          python credential_manager/tests/test_create_sheet.py
